<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="supplymule" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://x4libonline.ddns.net\libraries\aiscripts.xsd" version="1">
	<!-- Setup context menu order-->
	<order id="SupplyMule" name="M4- Supply Mule" description="Supplys own Stations Needs" category="trade" infinite="true">
		<params>
			<!-- menu option: Source Station (Define Source Station)-->
			<param name="sourceStation" required="false" default="null" type="object" text="Source Station" comment="The source station">
				<input_param name="class" value="[class.station]" />
			</param>
			<!-- menu option: Assign Ship to Station (Are we assigning this ship to a station if player owned.)-->
			<param name="assignSrc" type="bool" default="false" text="Assign Ship To Station" comment="Assign to the source station if it's the players." />
			<!-- menu option: Serve Source Only (will only serve the source station if used)-->
			<param name="dedicatedServe" type="bool" default="false" text="Serve Source Only" comment="Will only serve the configured source station" />
			<!-- menu option: Player Stations Only (will only buy from player owned station if used)-->
			<param name="tradeWithOwn" required="false" type="bool" default="false" text="Player Stations Only" comment="Buys from player stations only" />
			<!-- menu option: Max Trades (Maximum trades per buy run)-->
			<param name="maxtrades" required="false" default="[5 + this.ship.pilot.skill.piloting * 2, 20].min" type="number" text="Max Trades" comment="Max Trades per buy run.">
				<input_param name="startvalue" value="[5 + this.ship.pilot.skill.piloting * 2, 20].min" />
				<input_param name="min" value="1" />
				<input_param name="max" value="5 + this.ship.pilot.skill.piloting * 2" />
				<input_param name="step" value="1" />
			</param>
			<!-- menu option: Max Distance (Maximum Jumpes to buy)-->
			<param name="maxDist" required="false" default="this.ship.pilot.skill.piloting * 2" type="number" text="Max Jumps" comment="Max gate distance to buy.">
				<input_param name="startvalue" value="this.ship.pilot.skill.piloting * 2" />
				<input_param name="min" value="0" />
				<input_param name="max" value="this.ship.pilot.skill.piloting * 2" />
				<input_param name="step" value="1" />
			</param>
			<!-- menu option: Give Builders Priority (Supply builder sites before other station needs if used)-->
			<param name="builder" type="bool" default="true" text="Give Builders Priority" comment="Prioritizes supplying build sites before station needs." />
			<!-- menu option: WareBasket List-->
			<param name="specialWareBasket" required="false" default="[]" type="list" text="Wares (all by default)" comment="Warebasket">
				<input_param name="type" value="'ware'" />
				<input_param name="cancarry" value="this.ship" />
			</param>
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true" /> <!-- no idea wtf this is for-->
		</requires>
	</order>

	<interrupts>
		<handler ref="AttackHandler" />
		<handler ref="MissileLockHandler" />
		<handler ref="ScannedHandler" />
		<handler ref="InspectedHandler" />
		<handler ref="FoundAbandonedHandler" />
		<handler ref="ResupplyHandler" />
		<handler ref="JobRemoveRequestHandler" />
		<handler ref="TargetInvalidHandler" />
	</interrupts>

	<init>
		<set_value name="$object" exact="this.assignedcontrolled" />
		<set_order_syncpoint_reached order="this.ship.order" />
		<set_command_action commandaction="commandaction.searchingtrades" />
		<do_if value="$sourceStation and ($sourceStation.owner == this.ship.owner) and $assignSrc">
			<set_object_commander object="this.ship" commander="$sourceStation" />
		</do_if>
	</init>

	<attention min="unknown">
		<actions>
			<label name="start" />
			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'ScriptStart'" output="false" append="false" />
			<set_value name="$StartTime" exact="player.age" />
			<set_value name="$PerformanceTime" exact="player.age" />

			<do_if value="$dedicatedServe and not $sourceStation">
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Invalid Config: dedicatedServe (No Station configured)'" output="false" append="true" />
				<set_value name="$dedicatedServe" exact="false" />
			</do_if>

			<do_if value="$assignSrc and not $sourceStation">
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Invalid Config: assignSrc (No Station configured)'" output="false" append="true" />
				<set_value name="$assignSrc" exact="false" />
			</do_if>

			<!--here we want to copy settings to subordinates-->
			<set_value name="$subordinates" exact="this.ship.subordinates" />
			<set_value name="$subNr" exact="$subordinates.count" />
			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'found subordinates: '+$subNr" output="false" append="true" />
			<do_all exact="$subNr" counter="$nr">
				<set_value name="$subordinate" exact="$subordinates.{$nr}" />
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'  '+$nr+' '+$subordinate.knownname" output="false" append="true" />
				<do_if value="$subordinate.type != this.ship.type">
					<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'    not same shiptype: '+$subordinate.type+' and '+this.ship.type" output="false" append="true" />
					<continue />
				</do_if>
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'    copying default behavior'" output="false" append="true" />
				<remove_object_commander object="$subordinate" />
				<create_order object="$subordinate" default="true" id="'SupplyMule'">
					<param name="sourceStation" value="$sourceStation" />
					<param name="assignSrc" value="$assignSrc" />
					<param name="dedicatedServe" value="$dedicatedServe" />
					<param name="tradeWithOwn" value="$tradeWithOwn" />
					<param name="maxtrades" value="5 + this.ship.pilot.skill.piloting * 2" />
					<param name="maxDist" value="@this.ship.pilot.skill.piloting * 2" />
					<param name="builder" value="$builder" />
					<param name="specialWareBasket" value="$specialWareBasket" />
				</create_order>
				<wait exact="10ms" />
			</do_all>
			<remove_value name="$subordinates" />
			<remove_value name="$subNr" />
			<remove_value name="$subordinate" />


			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Setting subordinates used up: ' + (player.age-$PerformanceTime) + ' Seconds'" />
			<set_value name="$PerformanceTime" exact="player.age" />

			<create_list name="$Supplier" />
			<create_list name="$needs" />
			<set_value name="$ShipCapacity" exact="this.ship.cargo.capacity.all" />
			<set_value name="$MinCargoSize" exact="$ShipCapacity / $maxtrades" />
			<set_value name="$StartPosition" exact="if $dedicatedServe and $sourceStation then $sourceStation else this.ship" />

			<!-- Sell leftover cargo before regular Mule duty -->
			<set_value name="$currentcargo" exact="this.ship.cargo.list" />
			<do_if value="$currentcargo.count">
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Attempt sell leftover cargo'" output="false" append="true" />
				<find_buy_offer tradepartner="this.ship" space="player.galaxy" result="$needs" wares="$currentcargo" multiple="true"></find_buy_offer>
				<sort_trades name="$needs" tradelist="$needs" sorter="totalvolume" />
				<do_all exact="$currentcargo.count" counter="$cc">
					<set_value name="$ccNeedFound" exact="false" />
					<do_all exact="$needs.count" counter="$ccn">
						<set_value name="$cargoHauled" exact="[this.ship.cargo.{$currentcargo.{$cc}}.count,$needs.{$ccn}.amount].min" />
						<do_if value="$currentcargo.{$cc} == $needs.{$ccn}.ware and $cargoHauled gt (this.ship.cargo.{$currentcargo.{$cc}}.count / 5)">
							<do_if value="not $ccNeedFound">
								<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Sell cargo before beginning job: ' + $needs.{$ccn}.ware.id" output="false" append="true" />
								<create_trade_order name="$dropSupply" object="this.object" tradeoffer="$needs.{$ccn}" amount="$cargoHauled" immediate="false" />
							</do_if>
							<set_value name="$ccNeedFound" exact="true" />
						</do_if>
					</do_all>
				</do_all>
				<wait exact="100ms" />
				<resume label="start" />
			</do_if>

			<!-- Debug: Selling left over wares performance metrics -->
			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Selling leftover cargo used up: ' + (player.age-$PerformanceTime) + ' Seconds'" />
			<set_value name="$PerformanceTime" exact="player.age" />

			<!-- Debug: Defined Wares  -->
			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Define Wares'" output="false" append="true" />
			<do_if value="$dedicatedServe and $sourceStation">

				<!-- If Warebasket is EMPTY, add the repective wares of the source station -->
				<do_if value="$specialWareBasket == []">
					<set_value name="$resources" exact="$sourceStation.resources.list" />
					<do_all exact="$resources.count" counter="$nr">
						<append_to_list name="$specialWareBasket" exact="$resources.{$nr}" />
					</do_all>
					<remove_value name="$resources" />

					<set_value name="$supplyresources" exact="$sourceStation.supplyresources.list" />
					<do_all exact="$supplyresources.count" counter="$nr2">
						<append_to_list name="$specialWareBasket" exact="$supplyresources.{$nr2}" />
					</do_all>
					<remove_value name="$supplyresources" />

					<set_value name="$tradewares" exact="$sourceStation.tradewares.list" />
					<do_all exact="$tradewares.count" counter="$nr3">
						<append_to_list name="$specialWareBasket" exact="$tradewares.{$nr3}" />
					</do_all>
					<remove_value name="$tradewares" />
				</do_if>

				<!-- If station is a factory/shipyard station, remove all wares which are not wares of that station-->
				<create_list name="$wareBasket" />
				<do_if value="$sourceStation.products.count gt 0 or $sourceStation.canbuildships or $sourceStation.canequipships">
					<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Factory/Shipyard detected: Resources: ' + $sourceStation.resources.count + ' Products: ' + $sourceStation.products.count + ' Warebasket: ' + $specialWareBasket.count" output="false" append="true" />
					<set_value name="$resources" exact="$sourceStation.resources.list" />
					<do_all exact="$resources.count" counter="$nr">
						<do_if value="$specialWareBasket.indexof.{$resources.{$nr}}">
							<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Adding Resource: ' + $resources.{$nr}.id" output="false" append="true" />
							<append_to_list name="$wareBasket" exact="$resources.{$nr}" />
						</do_if>
					</do_all>
					<remove_value name="$resources" />

					<set_value name="$supplyresources" exact="$sourceStation.supplyresources.list" />
					<do_all exact="$supplyresources.count" counter="$nr2">
						<do_if value="$specialWareBasket.indexof.{$supplyresources.{$nr}}">
							<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Adding Supply: ' + $supplyresources.{$nr2}.id" output="false" append="true" />
							<append_to_list name="$wareBasket" exact="$supplyresources.{$nr2}" />
						</do_if>
					</do_all>
					<remove_value name="$supplyresources" />

					<set_value name="$tradewares" exact="$sourceStation.tradewares.list" />
					<do_all exact="$tradewares.count" counter="$nr3">
						<do_if value="$specialWareBasket.indexof.{$tradewares.{$nr}}">
							<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Adding Tradeware: ' + $tradewares.{$nr3}.id" output="false" append="true" />
							<append_to_list name="$wareBasket" exact="$tradewares.{$nr3}" />
						</do_if>
					</do_all>
					<remove_value name="$tradewares" />
				</do_if>

				<!-- AI Trade stations, remove everything which is not a trade ware -->
				<do_elseif value="$sourceStation.tradewares.count gt 0 and $sourceStation.owner != this.ship.owner">
					<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Trade station detected: Tradewares: ' + $sourceStation.tradewares.count + ' Warebasket: ' + $specialWareBasket.count" output="false" append="true" />
					<set_value name="$tradewares" exact="$sourceStation.tradewares.list" />
					<do_all exact="$tradewares.count" counter="$nr4">
						<do_if value="$specialWareBasket.indexof.{$tradewares.{$nr}}">
							<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Adding Tradeware: ' + $tradewares.{$nr4}.id" output="false" append="true" />
							<append_to_list name="$wareBasket" exact="$tradewares.{$nr4}" />
						</do_if>
					</do_all>
					<remove_value name="$tradewares" />
				</do_elseif>

				<!-- Add trade wares to player warehouse -->
				<do_elseif value="$sourceStation.owner == this.ship.owner">
					<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Warehouse detected: Tradewares: ' + $sourceStation.tradewares.count + ' Warebasket: ' + $specialWareBasket.count" output="false" append="true" />
					<set_value name="$wareBasket" exact="$specialWareBasket" />
					<do_all exact="$wareBasket.count" counter="$v1">
						<do_if value="not $sourceStation.tradewares.indexof.{$wareBasket.{$v1}}">
							<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Adding Offer: ' + $wareBasket.{$v1} + ' ' + $wareBasket.count + ' Tradeware count: ' + $sourceStation.tradewares.count" output="false" append="true" />
							<add_tradeware object="$sourceStation" ware="$wareBasket.{$v1}" allowbuy="true" allowsell="true" lockavgprice="false" />
							<wait exact="100ms" />
						</do_if>
					</do_all>
				</do_elseif>
			</do_if>

			<do_else>
				<do_if value="$specialWareBasket == []">
					<set_value name="$AllWares" exact="[ware.spacefuel,ware.spaceweed,ware.advancedcomposites,ware.advancedelectronics,ware.antimattercells,ware.antimatterconverters,ware.claytronics,
                     ware.dronecomponents,ware.engineparts,ware.fieldcoils,ware.hullparts,ware.refinedmetals,ware.scanningarrays,ware.shieldcomponents,ware.siliconwafers,
                     ware.teladianium,ware.turretcomponents,ware.water,ware.wheat,ware.energycells,ware.foodrations,ware.graphene,ware.majadust,ware.majasnails,ware.meat,
                     ware.microchips,ware.quantumtubes,ware.medicalsupplies,ware.missilecomponents,ware.nostropoil,ware.plasmaconductors,ware.smartchips,ware.sojabeans,
                     ware.sojahusk,ware.spices,ware.sunriseflowers,ware.superfluidcoolant,ware.swampplant,ware.weaponcomponents]" />
					<do_all exact="$AllWares.count" counter="$v9">
						<append_to_list name="$specialWareBasket" exact="$AllWares.{$v9}" />
					</do_all>
				</do_if>
				<set_value name="$wareBasket" exact="$specialWareBasket" />
			</do_else>

			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Setting Warebasket used up: ' + (player.age-$PerformanceTime) + ' Seconds'" />
			<set_value name="$PerformanceTime" exact="player.age" />

			<!-- Find build site demands (used when 'Give Builders Priority') -->
			<do_if value="$builder">
				<find_buy_offer space="player.galaxy" result="$needs" wares="$wareBasket" multiple="true" excludeempty="false">
					<match_buyer class="class.buildstorage" owner="this.ship.owner">
						<match_gate_distance object="$StartPosition" max="$maxDist">
							<blacklist group="blacklistgroup.civilian" object="this.ship" />
						</match_gate_distance>
						<match_parent>
							<match_parent>
								<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship" />
								<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship" />
							</match_parent>
						</match_parent>
					</match_buyer>
				</find_buy_offer>

				<do_if value="$needs.count">
					<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="$needs.count + ' Build demands found'" output="false" append="true" />
					<set_value name="$BuilderList" exact="true" />

					<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Finding building needs used up: ' + (player.age-$PerformanceTime) + ' Seconds'" />
					<set_value name="$PerformanceTime" exact="player.age" />

					<resume label="SortTrades" />
				</do_if>
			</do_if>


			<!-- Find supply demands -->
			<label name="Supply" />
			<set_value name="$BuilderList" exact="false" />
			<do_if value="$needs.count == 0">
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Continue with regular Demands'" output="false" append="true" />
				<do_if value="$dedicatedServe">
					<find_buy_offer tradepartner="this.ship" buyer="$sourceStation" result="$needs" wares="$wareBasket" multiple="true">
						<match_buyer>
							<match_gate_distance object="$StartPosition" max="$maxDist">
								<blacklist group="blacklistgroup.civilian" object="this.ship" />
							</match_gate_distance>
							<match_parent>
								<match_parent>
									<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship" />
									<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship" />
								</match_parent>
							</match_parent>
						</match_buyer>
					</find_buy_offer>
				</do_if>
				<do_else>
					<find_buy_offer space="player.galaxy" result="$needs" wares="$wareBasket" multiple="true" excludeempty="false">
						<match_buyer owner="this.ship.owner">
							<match_gate_distance object="$StartPosition" max="$maxDist">
								<blacklist group="blacklistgroup.civilian" object="this.ship" />
							</match_gate_distance>
							<match_parent>
								<match_parent>
									<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship" />
									<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship" />
								</match_parent>
							</match_parent>
						</match_buyer>
					</find_buy_offer>
				</do_else>
			</do_if>

			<!-- Debug: Supply needs performance metrics-->
			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Finding supply needs used up: ' + (player.age-$PerformanceTime) + ' Seconds'" />
			<set_value name="$PerformanceTime" exact="player.age" />

			<!-- Sort Demands -->
			<label name="SortTrades" />
			<create_list name="$needsValues" />
			<do_all exact="$needs.count" counter="$vy">
				<append_to_list name="$needsValues" exact="(($needs.{$vy}.desiredamount)f / ($needs.{$vy}.owner.cargo.{$needs.{$vy}.ware}.target)f)*1000" />
			</do_all>

			<!-- This sorting method should be replaced with vanilla function at some stage ;Misunderstood Wookiee -->
			<run_script name="'quicksort'">
				<param name="objects" value="$needs" />
				<param name="values" value="$needsValues" />
				<save_retval name="sortedobject" variable="$needs2" />
				<save_retval name="sortedvalue" variable="$needs2Values" />
			</run_script>

			<do_if value="$needs.count gt $needs2.count">
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Quicksort execution failed, is quicksort installed?'" output="false" append="true" />
				<sort_trades name="$needs2" tradelist="$needs" sorter="stocklevel" />
			</do_if>

			<!-- Invert Demand (Least stock first) and only search offers for demanded wares -->
			<create_list name="$Demands" />
			<do_all exact="$needs2.count" counter="$vy">
				<append_to_list name="$Demands" exact="$needs2.{$needs2.count-$vy+1}" />
				<do_if value="not $wareBasket.indexof.{$needs2.{$needs2.count-$vy+1}.ware}">
					<append_to_list name="$wareBasket" exact="$needs2.{$needs2.count-$vy+1}.ware" />
				</do_if>
			</do_all>


			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Sorting needs used up: ' + (player.age-$PerformanceTime) + ' Seconds'" />
			<set_value name="$PerformanceTime" exact="player.age" />

			<do_all exact="$Demands.count" counter="$vy1">
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Sorted Objects: ' + $Demands.{$vy1}.owner.idcode + ' Ware: ' + $Demands.{$vy1}.ware.id + ' Value: ' + (($Demands.{$vy1}.desiredamount)f / ($Demands.{$vy1}.owner.cargo.{$Demands.{$vy1}.ware}.target)f)*1000 + ' Demand: ' + $Demands.{$vy1}.desiredamount + ' Max Store: ' + $Demands.{$vy1}.owner.cargo.{$Demands.{$vy1}.ware}.target" output="false" append="true" />
			</do_all>

			<!-- Trade only with own stations -->
			<do_if value="$tradeWithOwn">
				<find_sell_offer tradepartner="this.ship" space="player.galaxy" result="$Supplier" wares="$wareBasket" multiple="true">
					<match_seller class="class.station">
						<match owner="this.ship.owner" />
						<match_gate_distance object="$StartPosition" max="$maxDist" />
						<match_parent>
							<match_parent>
								<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship" />
								<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship" />
							</match_parent>
						</match_parent>
					</match_seller>
				</find_sell_offer>
			</do_if>


			<!-- Trade with everyone -->
			<do_else>
				<find_sell_offer tradepartner="this.ship" space="player.galaxy" result="$Supplier" wares="$wareBasket" multiple="true">
					<match_seller tradesknownto="this.owner" class="class.station">
						<match_relation_to object="this.ship" relation="neutral" comparison="ge" />
						<match_gate_distance object="$StartPosition" min="0" max="$maxDist">
							<blacklist group="blacklistgroup.civilian" object="this.ship" />
						</match_gate_distance>
						<match_parent>
							<match_parent>
								<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship" />
								<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship" />
							</match_parent>
						</match_parent>
					</match_seller>
				</find_sell_offer>
			</do_else>

			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Finding sell offers used up: ' + (player.age-$PerformanceTime) + ' Seconds'" />
			<set_value name="$PerformanceTime" exact="player.age" />

			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Found Station need offers: ' + $Demands.count + ' Warebasket count: ' + $wareBasket.count + ' Sellers found: '+ $Supplier.count" output="false" append="true" />

			<create_list name="$TradeTargets" />
			<create_list name="$TradeWares" />
			<create_list name="$TradeAmounts" />
			<create_list name="$BuyerList" />

			<!-- Trade find logic -->
			<do_if value="$Supplier.count gt 0 and $wareBasket gt 0">
				<set_value name="$OccupiedCargo" exact="0" />
				<sort_trades name="$SupplierList" tradelist="$Supplier" sorter="amount" />

				<create_list name="$SupplierSorted" />
				<!-- Invert Supplies (Highest stock first) -->
				<do_all exact="$SupplierList.count" counter="$vy">
					<append_to_list name="$SupplierSorted" exact="$SupplierList.{$SupplierList.count-$vy+1}" />
				</do_all>
				<remove_value name="$SupplierList" />

				<do_all exact="$Demands.count" counter="$idx">
					<do_if value="$OccupiedCargo + $MinCargoSize / 2 ge $ShipCapacity">
						<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Cargo full, skipping'" output="false" append="true" />
						<break />
					</do_if>

					<set_value name="$someBuyer" exact="$Demands.{$idx}" />
					<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Buyer: ' + $someBuyer.owner.knownname + ' ' + $someBuyer.owner.idcode + ' Ware Required: ' + $someBuyer.ware.id + ' RequiredAmount: ' + $someBuyer.desiredamount" output="false" append="true" />

					<do_if value="($someBuyer.desiredamount * $someBuyer.ware.volume) lt $MinCargoSize">
						<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Demand too little: ' + $someBuyer.ware.id" output="false" append="true" />
						<break />
					</do_if>

					<do_all exact="$SupplierSorted.count" counter="$ctr">
						<do_if value="$OccupiedCargo + $MinCargoSize / 2 ge $ShipCapacity">
							<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Cargo full, skipping'" output="false" append="true" />
							<break />
						</do_if>

						<set_value name="$someSeller" exact="$SupplierSorted.{$ctr}" />
						<!-- avoid buying/selling to yourself -->
						<do_if value="$someBuyer.ware.id == $someSeller.ware.id and ($someSeller.owner != $someBuyer.owner or $someBuyer.owner.isclass.buildstorage)">
							<set_value name="$WareInList" exact="0" />
							<set_value name="$WareCountBought" exact="0" />
							<do_all exact="$TradeTargets.count" counter="$twc">
								<do_if value="$TradeTargets.{$twc}.ware == $someSeller.ware and $TradeTargets.{$twc} == $someBuyer">
									<set_value name="$WareInList" exact="$twc" />
									<set_value name="$WareCountBought" exact="$TradeAmounts.{$twc}" />
								</do_if>
							</do_all>
							<do_if value="$someBuyer.owner.owner == this.ship.owner">
								<set_value name="$buyofferamount" exact="$someBuyer.desiredamount" />
							</do_if>
							<do_else>
								<set_value name="$buyofferamount" exact="$someBuyer.amount" />
							</do_else>
							<set_value name="$CargoWareFree" exact="(($ShipCapacity - $OccupiedCargo)/$someSeller.ware.volume)" />
							<set_value name="$cargoHauled" exact="[$CargoWareFree,$someSeller.amount,($buyofferamount-$WareCountBought)].min" />
							<set_value name="$cargoSpace" exact="($cargoHauled * $someSeller.ware.volume)" />
							<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Seller: ' + $someSeller.owner.knownname + ' ' + $someSeller.owner.idcode + ' Min trade cargo:  ' + $MinCargoSize + ' Buy cargo space requirement: ' + $cargoSpace + ' Trade amount: ' + $cargoHauled +  ' Already bought Wares: ' + $WareCountBought + ' Desired amount ' + $buyofferamount + ' Desired amount left: ' + ($buyofferamount-$WareCountBought) + ' Seller offer: ' + $someSeller.amount + ' Stocklevel: ' + $someSeller.stocklevel" output="false" append="true" />
							<!-- Test if ship capacity is reached, min trade volume is reached and allow one extra half sized trade when it fills the cargo 100% -->
							<do_if value="$cargoHauled gt 0 and $ShipCapacity ge ($OccupiedCargo + $cargoSpace) and ($cargoSpace gt $MinCargoSize or ($cargoHauled == $CargoWareFree and $cargoSpace ge $MinCargoSize / 2) or $cargoHauled == ($buyofferamount-$WareCountBought)) ">
								<do_if value="$WareInList">
									<set_value name="$TradeAmounts.{$WareInList}" exact="$TradeAmounts.{$WareInList} + $cargoHauled" />
									<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Modify Ware : ' + $someSeller.ware.id + ' Amount: ' + $cargoHauled" output="false" append="true" />
								</do_if>
								<do_else>
									<append_to_list name="$TradeAmounts" exact="$cargoHauled" />
									<append_to_list name="$TradeTargets" exact="$someBuyer" />
									<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Add Ware : ' + $someBuyer.ware.id + ' Amount: ' + $cargoHauled" output="false" append="true" />
								</do_else>

								<set_value name="$OccupiedCargo" exact="$OccupiedCargo + $cargoSpace" />
								<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Query Buy: : ' + $someSeller.ware.id + ' Amount: ' + $cargoHauled + ' DesiredAmount left: ' + ($buyofferamount-$WareCountBought)" output="false" append="true" />
								<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' New occupied space : ' + $OccupiedCargo + ' MaxSpace: ' + $ShipCapacity" output="false" append="true" />
								<create_trade_order name="$getSupply" object="this.object" tradeoffer="$someSeller" amount="$cargoHauled" immediate="false" />
							</do_if>
						</do_if>
					</do_all>
				</do_all>

				<do_if value="$BuilderList and $TradeTargets.count == 0">
					<remove_value name="$SupplierSorted" />
					<remove_value name="$Demands" />
					<remove_value name="$needs" />
					<resume label="Supply" />
				</do_if>

				<do_all exact="$TradeTargets.count" counter="$idc">
					<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Query Sell: : ' + $TradeTargets.{$idc}.ware.id + ' Target:  ' + $TradeTargets.{$idc}.owner.knownname + ' ' + $TradeTargets.{$idc}.owner.idcode + ' Amount ' + $TradeAmounts.{$idc}" output="false" append="true" />
					<create_trade_order name="$dropSupply" object="this.object" tradeoffer="$TradeTargets.{$idc}" amount="$TradeAmounts.{$idc}" immediate="false" />
				</do_all>

				<!-- Leave builder area after selling to builder to avoid traffic jam (no longer used) -->
				<!--  			<do_if value="$BuilderList and $TradeTargets.count">
				<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Moving to avoid Traffic Jam'" />
				<select_flight_behaviour entity="this" evasive="true" result="$fb"/>
				<move_to object="this.ship" abortpath="false" destination="this.ship.zone" flightbehaviour="$fb" boost="false">
					<position object="this.ship" min="1km" max="2km"/>
					<interrupt_after_time time="60s"/>
				</move_to>
			</do_if> -->
			</do_if> <!-- the stations have supply and demand -->

			<!-- Debug: Finding trade routes performance metrics-->
			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Finding trade routes used up: ' + (player.age-$PerformanceTime) + ' seconds'" />
			<set_value name="$PerformanceTime" exact="player.age" />

			<remove_value name="$TradeAmounts" />
			<remove_value name="$TradeTargets" />
			<remove_value name="$TradeAmounts" />
			<remove_value name="$BuyerList" />


			<remove_value name="$WareInList" />
			<remove_value name="$WareCountBought" />
			<remove_value name="$OccupiedCargo" />

			<remove_value name="$wareBasket" />
			<remove_value name="$Demands" />

			<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="' Script used up: ' + (player.age-$StartTime) + '  seconds'" />
			<wait exact="60s" />
			<resume label="start" />
		</actions>
	</attention>
</aiscript>