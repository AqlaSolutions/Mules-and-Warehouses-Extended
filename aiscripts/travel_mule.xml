<?xml version="1.0" encoding="utf-8" ?>
<aiscript name="travelmule" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://x4libonline.ddns.net\libraries\aiscripts.xsd" version="1">
	<!-- Setup context menu order-->
	<order id="TravelMule" name="M1- Travel Mule" description="Ferries supplies between stations" category="trade" infinite="true">
		<params>
			<!-- menu option: Source Station (Define Source Station)-->
			<param name="sourceStation" required="false" default="null" type="object" text="Source Station" comment="The source station">
				<input_param name="class" value="[class.station]" />
			</param>
			<!-- menu option: Target NPC Shipyards, Whalfs, Equipment Docks-->
			<param name="tradeWithBig" required="false" type="bool" default="false" text="Target NPC Shipyards" comment="Assign to trade with all NPC shipyards, wharfs, and equip docks." />
			<!-- menu option: Target All NPC Stations (trade with any station toggle)-->
			<param name="tradeWithAll" required="false" type="bool" default="true" text="Target All NPC Stations" comment="Assign to trade with all NPC stations." />
			<!-- menu option: Max Gate Distance-->
			<param name="maxDist" required="false" default="8" type="number" text="Max Jumps" comment="Max Gate Distance to sell.">
				<input_param name="startvalue" value="15" />
				<input_param name="min" value="0" />
				<input_param name="max" value="15" />
				<input_param name="step" value="1" />
			</param>
			<!-- menu option: WareBasket List-->
			<param name="specialWareBasket" required="false" default="[]" type="list" text="Wares (all by default)" comment="Warebasket">
				<input_param name="type" value="'ware'" />
				<input_param name="cancarry" value="this.ship" />
			</param>
			<!-- menu option: Destination Override (select stations manually to visit)-->
			<param name="destList" required="false" default="[]" type="list" text="Custom Stop List (Replaces 'Target' Options)" comment="Manually choose Points to visit.">
				<input_param name="type" value="'object'" />
			</param>
		</params>
		<requires>
			<match shiptype="shiptype.lasertower" negate="true" /> <!-- no idea wtf this is for-->
		</requires>
	</order>

	<interrupts>
		<handler ref="AttackHandler" />
		<handler ref="MissileLockHandler" />
		<handler ref="ScannedHandler" />
		<handler ref="InspectedHandler" />
		<handler ref="FoundAbandonedHandler" />
		<handler ref="ResupplyHandler" />
		<handler ref="JobRemoveRequestHandler" />
		<handler ref="TargetInvalidHandler" />
	</interrupts>

	<init>
		<set_value name="$debugchance" exact="100"/>
		<debug_to_file chance="$debugchance" name="this.ship.knownname" directory="'MulesExtended'" text="'Starting Log File'" output="false" append="false" />
		<set_value name="$object" exact="this.assignedcontrolled" />
		<set_order_syncpoint_reached order="this.ship.order" />
		<set_command_action commandaction="commandaction.searchingtrades" />
		<do_if value="($sourceStation.owner == this.ship.owner)">
			<set_object_commander object="this.ship" commander="$sourceStation" />
		</do_if>
	</init>

	<attention min="unknown">
		<actions>
			<label name="start" />

			<set_value name="$needFound" exact="false" />
			<set_value name="$supplyTarget" exact="0" />
			<set_value name="$supplySource" exact="0" />
			<set_value name="$bestProfit" exact="0" />
			<set_value name="$bestCargo" exact="0" />
			<set_value name="$currentProfit" exact="0" />
			<create_list name="$supplies" />
			<create_list name="$needs" />
			<create_list name="$innerList" />
			<create_list name="$outerList" />
			<create_list name="$tempList" />

			<!-- Sell leftover cargo before resuming regular Mule routine -->
			<set_value name="$currentcargo" exact="this.ship.cargo.list" />
			<do_if value="$currentcargo.count">
				<find_buy_offer tradepartner="this.ship" space="player.galaxy" result="$needs" wares="$currentcargo" multiple="true"></find_buy_offer>
				<sort_trades name="$needs" tradelist="$needs" sorter="totalvolume" />
				<do_all exact="$currentcargo.count" counter="$cc">
					<set_value name="$ccNeedFound" exact="false" />
					<do_all exact="$needs.count" counter="$ccn">
						<set_value name="$cargoHauled" exact="[this.ship.cargo.{$currentcargo.{$cc}}.count,$needs.{$ccn}.amount].min" />
						<do_if value="$currentcargo.{$cc} == $needs.{$ccn}.ware and $cargoHauled gt (this.ship.cargo.{$currentcargo.{$cc}}.count / 5)">
							<do_if value="not $ccNeedFound">
								<debug_to_file chance="$debugchance" name="'SupplyMule- ' + this.ship.knownname + ' ' + this.ship.idcode" directory="'MulesExtended'" text="'Sell cargo before beginning job: ' + $needs.{$ccn}.ware.id" output="false" append="true" />
								<create_trade_order name="$dropSupply" object="this.object" tradeoffer="$needs.{$ccn}" amount="$cargoHauled" immediate="false" />
								<break></break>
							</do_if>
							<set_value name="$ccNeedFound" exact="true" />
						</do_if>
					</do_all>
				</do_all>
				<wait exact="100ms" />
				<resume label="start" />
			</do_if>

			<set_value name="$wareBasket" exact="$specialWareBasket" />
			<do_if value="$wareBasket == []">
				<do_if value="$sourceStation.tradewares.count">
					<set_value name="$wareBasket" exact="$sourceStation.tradewares.list" />
				</do_if>
				<do_elseif value="$sourceStation.products.count">
					<set_value name="$wareBasket" exact="$sourceStation.products.list" />
				</do_elseif>
			</do_if>

			<!-- technically sourceStation could be owned by someone on the blacklist, but the player picked this manually -->
			<find_sell_offer tradepartner="this.ship" seller="$sourceStation" result="$supplies" wares="$wareBasket" multiple="true">
				<match_seller>
					<match_gate_distance object="this.ship" min="0">
						<blacklist group="blacklistgroup.civilian" object="this.ship" />
					</match_gate_distance>
					<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.objectactivity" object="this.ship"/>
					<match_parent>
						<match_parent>
						  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship"/>
						  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship"/>
						</match_parent>
					</match_parent>
				</match_seller>
			</find_sell_offer>

			<debug_to_file chance="$debugchance" name="this.ship.knownname" directory="'MulesExtended'" text="'supplies: ' +$supplies" output="false" append="true" />


			<!-- TODO: refactor these blocks -->
			<!-- maxDist of 15 is the equivalent of "no limit" apparently -->
			<!-- Finding Buyers -->
			<do_if value="$destList == []">
				<do_if value="$maxDist == 15">
					<do_if value="$tradeWithAll">
						<find_buy_offer tradepartner="this.ship" space="player.galaxy" result="$needs" wares="$wareBasket" multiple="true">
							<match_buyer>
								<match_gate_distance object="$sourceStation">
									<blacklist group="blacklistgroup.civilian" object="this.ship" />
								</match_gate_distance>
								<match_relation_to object="this.ship" relation="enemy" comparison="not" />
								<match tradesknownto="this.owner" />
								<match owner="this.ship.owner" negate="true" />
								<match class="class.station" />
								<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.objectactivity" object="this.ship"/>
								<match_parent>
									<match_parent>
									  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship"/>
									  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship"/>
									</match_parent>
								</match_parent>
							</match_buyer>
						</find_buy_offer>
					</do_if>
					<do_elseif value="$tradeWithBig">
						<find_buy_offer tradepartner="this.ship" space="player.galaxy" result="$needs" wares="$wareBasket" multiple="true">
							<match_buyer>
								<match_gate_distance object="$sourceStation">
									<blacklist group="blacklistgroup.civilian" object="this.ship" />
								</match_gate_distance>
								<match_relation_to object="this.ship" relation="enemy" comparison="not" />
								<match tradesknownto="this.owner" />
								<match owner="this.ship.owner" negate="true" />
								<match class="class.station" />
								<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.objectactivity" object="this.ship"/>
								<match_parent>
									<match_parent>
									  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship"/>
									  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship"/>
									</match_parent>
								</match_parent>
								<match_any>
									<match canbuildships="true" />
									<match canequipships="true" />
								</match_any>
							</match_buyer>
						</find_buy_offer>
					</do_elseif>
				</do_if>
				<do_else>
					<find_cluster_in_range distances="$clusterstable" multiple="true" object="$sourceStation.cluster" mindistance="0" maxdistance="$maxDist"/>
					<set_value name="$sellspaces" exact="$clusterstable.keys.sorted" />
					<remove_value name="$clusterstable" />
					<do_all exact="$sellspaces.count" counter="$sector">
						<do_if value="$tradeWithAll">
							<find_buy_offer tradepartner="this.ship" space="$sellspaces.{$sector}" result="$tempList" wares="$wareBasket" multiple="true">
								<match_buyer>
									<match_gate_distance object="$sourceStation" max="$maxDist">
										<blacklist group="blacklistgroup.civilian" object="this.ship" />
									</match_gate_distance>
									<match_relation_to object="this.ship" relation="enemy" comparison="not" />
									<match tradesknownto="this.owner" />
									<match owner="this.ship.owner" negate="true" />
									<match class="class.station" />
									<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.objectactivity" object="this.ship"/>
									<match_parent>
										<match_parent>
										  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship"/>
										  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship"/>
										</match_parent>
									</match_parent>
								</match_buyer>
							</find_buy_offer>
						</do_if>
						<do_elseif value="$tradeWithBig">
							<find_buy_offer tradepartner="this.ship" space="$sellspaces.{$sector}" result="$tempList" wares="$wareBasket" multiple="true">
								<match_buyer>
									<match_gate_distance object="$sourceStation" max="$maxDist">
										<blacklist group="blacklistgroup.civilian" object="this.ship" />
									</match_gate_distance>
									<match_relation_to object="this.ship" relation="enemy" comparison="not" />
									<match tradesknownto="this.owner" />
									<match owner="this.ship.owner" negate="true" />
									<match class="class.station" />
									<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.objectactivity" object="this.ship"/>
									<match_parent>
										<match_parent>
										  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship"/>
										  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship"/>
										</match_parent>
									</match_parent>
									<match_any>
										<match canbuildships="true" />
										<match canequipships="true" />
									</match_any>
								</match_buyer>
							</find_buy_offer>
						</do_elseif>

						<do_all exact="$tempList.count" counter="$tl">
							<append_to_list name="$needs" exact="$tempList.{$tl}" />
						</do_all>
					</do_all>
				</do_else>
				<debug_to_file chance="$debugchance" name="this.ship.knownname" directory="'MulesExtended'" text="'needs: ' +$needs" output="false" append="true" />
				<do_all exact="$needs.count" counter="$i">
					<debug_to_file chance="$debugchance" name="this.ship.knownname" directory="'MulesExtended'" text="'  ' +$needs.{$i}.ware + ' ' +$needs.{$i}.owner.knownname" output="false" append="true" />
				</do_all>
			</do_if>

			<do_else>
				<do_all exact="$destList.count" counter="$customer">
					<!-- the destList was built by the user manually in the UI so dont filter by blacklist -->
					<find_buy_offer tradepartner="this.ship" buyer="$destList.{$customer}" result="$tempList" wares="$wareBasket" multiple="true">
						<match_buyer>
							<match_gate_distance object="$sourceStation" max="$maxDist">
								<blacklist group="blacklistgroup.civilian" object="this.ship" />
							</match_gate_distance>
							<match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.objectactivity" object="this.ship"/>
							<match_parent>
								<match_parent>
								  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectortravel" object="this.ship"/>
								  <match_use_blacklist group="blacklistgroup.civilian" type="blacklisttype.sectoractivity" object="this.ship"/>
								</match_parent>
							</match_parent>
						</match_buyer>
					</find_buy_offer>

					<do_all exact="$tempList.count" counter="$tl">
						<append_to_list name="$needs" exact="$tempList.{$tl}" />
					</do_all>
				</do_all>
			</do_else>

			<!-- Regular Travelling Mule Routine -->
			<do_if value="$needs.count gt 0 and $supplies.count gt 0">
				<set_value name="$innerList" exact="$needs" />
				<sort_trades name="$outerList" tradelist="$supplies" sorter="volume" />

				<do_all exact="$outerList.count" counter="$idx">
					<do_if value="not $needFound">
						<set_value name="$someOuter" exact="$outerList.{$idx}" />
						<do_all exact="$innerList.count" counter="$ctr">
							<set_value name="$someInner" exact="$innerList.{$ctr}" />
							<do_if value="$someOuter.ware.id" exact="$someInner.ware.id">
								<!-- find need-->
								<do_if value="$someInner.owner.owner == this.ship.owner">
									<set_value name="$targetAmount" exact="$someInner.desiredamount" />
								</do_if>
								<do_else>
									<set_value name="$targetAmount" exact="$someInner.amount" />
								</do_else>
								<set_value name="$cargoHauled" exact="[this.ship.cargo.{$someInner.ware}.free,$targetAmount,$someOuter.amount].min" />
								<set_value name="$currentProfit" exact="$cargoHauled * ($someInner.unitprice - $someOuter.unitprice)" />
								<do_if value="($currentProfit gt $bestProfit) and ($cargoHauled gt (this.ship.cargo.{$someInner.ware}.max / 1.25))">
									<set_value name="$supplyTarget" exact="$someInner" />
									<set_value name="$bestCargo" exact="$cargoHauled" />
									<do_if value="not $needFound">
										<set_value name="$needFound" exact="true" />
										<set_value name="$supplySource" exact="$someOuter" />
									</do_if>
								</do_if>
							</do_if> <!--need found-->
						</do_all>
						<debug_to_file chance="$debugchance" name="this.ship.knownname" directory="'MulesExtended'" text="'need found: ' +$needFound" output="false" append="true" />


						<do_if value="$needFound">
							<do_if value="$supplySource.owner.owner == this.ship.owner">
								<set_value name="$currentProfit" exact="$bestCargo * $supplyTarget.unitprice" />
								<write_to_logbook category="upkeep" title="'Travel Mule: '+this.ship.knownname" interaction="showonmap" object="this.ship" money="$currentProfit" text="'Buying ' +$bestCargo + ' ' +$supplySource.ware + ' from ' +$supplySource.seller.knownname + ' at -- (player owned) to sell to ' + $supplyTarget.buyer.knownname + ' at ' +$supplyTarget.unitprice/100 + ' for a profit of ' +$currentProfit/100" />
								<!--Debug: Print profit stats to logfile-->
								<debug_to_file chance="$debugchance" name="this.ship.knownname" directory="'MulesExtended'" text="'Buying ' +$bestCargo + ' ' +$supplySource.ware + ' from ' +$supplySource.seller.knownname + ' at -- (player owned) to sell to ' + $supplyTarget.buyer.knownname + ' at ' +$supplyTarget.unitprice/100 + ' for a profit of ' +$currentProfit/100" />
							</do_if>
							<do_else>
								<set_value name="$currentProfit" exact="$bestCargo * ($supplyTarget.unitprice - $supplySource.unitprice)" />
								<write_to_logbook category="upkeep" title="'Travel Mule: '+this.ship.knownname" interaction="showonmap" object="this.ship" money="$currentProfit" text="'Buying ' +$bestCargo + ' ' +$supplySource.ware + ' from ' +$supplySource.seller.knownname + ' at ' +$supplySource.unitprice/100 + ' to sell to ' + $supplyTarget.buyer.knownname + ' at ' +$supplyTarget.unitprice/100 + ' for a profit of ' +$currentProfit/100" />
								<!--Debug: Print profit stats to logfile-->
								<debug_to_file chance="$debugchance" name="this.ship.knownname" directory="'MulesExtended'" text="'Buying ' +$bestCargo + ' ' +$supplySource.ware + ' from ' +$supplySource.seller.knownname + ' at ' +$supplySource.unitprice/100 + ' to sell to ' + $supplyTarget.buyer.knownname + ' at ' +$supplyTarget.unitprice/100 + ' for a profit of ' +$currentProfit/100" />
							</do_else>

							<create_trade_order name="$getSupply" object="this.object" tradeoffer="$supplySource" amount="$bestCargo" immediate="false" />
							<create_trade_order name="$dropSupply" object="this.object" tradeoffer="$supplyTarget" amount="$bestCargo" immediate="false" />
						</do_if>
					</do_if>
				</do_all>
			</do_if> <!-- the stations have supply and demand -->

			<remove_value name="$supplyTarget" />
			<remove_value name="$supplySource" />
			<remove_value name="$supplies" />
			<remove_value name="$needs" />
			<remove_value name="$innerList" />
			<remove_value name="$outerList" />

			<wait exact="1000ms" />
			<resume label="start" />
		</actions>
	</attention>
</aiscript>